# 异常分析详细步骤

本文档提供异常分析的详细执行步骤，按四个阶段组织。

## 第一阶段：收集信息

### 1. 获取完整的堆栈跟踪

**目标**: 捕获完整的异常堆栈信息

**操作**:
- 使用 `Read` 工具读取日志文件或错误输出
- 识别异常类型（如 `TypeError`、`ValueError`、自定义异常）
- 定位异常抛出的确切位置：`文件路径:行号`
- 记录完整的错误消息

**输出**:
```
- 异常类型: ExceptionType
- 发生位置: module.py:line
- 错误消息: [完整错误消息]
```

### 2. 识别错误上下文

**目标**: 收集异常发生时的环境信息

**操作**:
- **输入数据**: 记录函数调用时的参数值
- **状态变量**: 记录相关变量的当前状态
- **环境信息**: 记录配置、依赖版本等

**工具**: `Read`、`Grep`（搜索配置定义）

### 3. 理解预期行为

**目标**: 确认当前行为与预期的差异

**操作**:
- 从代码文档或注释了解预期功能
- 阅读相关测试用例（如果有）
- 确认用户期望的行为是什么

**工具**: `Read`（读取 docstring、注释）、`Grep`（搜索相关测试）

## 第二阶段：定位问题

### 4. 追溯调用链

**目标**: 分析从入口点到异常点的完整调用路径

**操作**:
```
Entry Point → [中间调用层] → Exception Point
              ↑ 分析每一层
```

对调用链中的每个函数/方法：
- 检查参数传递是否正确
- 验证返回值是否符合预期
- 确认异常处理逻辑是否恰当

**工具**:
- `LSP.goToDefinition` - 跳转到函数定义
- `LSP.findReferences` - 查找函数调用位置
- `Read` - 阅读调用链代码

### 5. 检查数据流

**目标**: 追踪数据在传递过程中的变化

**操作**:
- 数据在传递过程中是否被意外修改
- 类型转换是否正确
- 边界条件是否处理（空值、最大/最小值）
- 数据结构是否一致

**工具**:
- `Grep` - 搜索变量名
- `Read` - 阅读数据处理代码

### 6. 审查并发控制（如适用）

**目标**: 检查多线程/并发相关的潜在问题

**检查项**:
- 锁的使用是否正确
- 是否存在竞态条件
- 共享状态的访问是否同步
- 死锁可能性

**工具**: `Read`、`Grep`（搜索 `Lock`、`threading`、`async`）

## 第三阶段：确定根因

### 7. 分类问题类型

| 类型 | 特征 | 常见原因 |
|------|------|----------|
| 逻辑错误 | 代码执行但结果不正确 | 算法错误、条件判断错误 |
| 运行时错误 | 程序崩溃或抛出异常 | 空指针、类型错误、索引越界 |
| 并发错误 | 间歇性出现，难以复现 | 竞态条件、死锁、资源泄漏 |
| 配置错误 | 环境相关 | 配置文件、环境变量、依赖版本 |

### 8. 构建根因假设

**目标**: 基于收集的证据提出最可能的根因

**操作**:
- 列出所有可能的根因
- 根据证据排除可能性较低的根因
- 选择最可能的根因作为假设

## 第四阶段：验证假设

### 9. 设计验证方法

**目标**: 验证根因假设是否正确

**方法**:
- 添加日志/断点验证假设
- 创建最小复现用例
- 对比正常路径和异常路径

**工具**: `Bash`（运行测试）、`Edit`（添加调试代码）

### 10. 确认根因

**判定**:
- 假设验证成功 → 确认根因
- 假设验证失败 → 返回步骤 7 重新分析
