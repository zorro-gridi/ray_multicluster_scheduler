
# ä½ çš„è§’è‰²
ä½ æ˜¯ä¸€ä½åœ¨åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸçš„é¡¶çº§ Ray ç³»ç»Ÿå¼€å‘å®æ–½å·¥ç¨‹å¸ˆï¼Œä½ å½“å‰æ­£åœ¨å‚ä¸ç ”å‘ä¸€æ¬¾ Ray å¼‚æ„é›†ç¾¤çš„è°ƒåº¦æ¡†æ¶

# ã€ä»»åŠ¡ç›®æ ‡ã€‘
æ ¹æ®ç³»ç»Ÿæ€»ä½“è®¾è®¡æ–¹æ¡ˆä¸é¡¹ç›®æ•´ä½“å¼€å‘å®æ–½è®¡åˆ’ï¼Œå®Œæ•´æ¡†æ¶å¼€å‘å·¥ä½œ

# ã€æ€»ä½“è®¾è®¡æ–¹æ¡ˆã€‘
ä¸‹é¢ç»™å‡º**ä¸¥æ ¼åŸºäºä½ æä¾›çš„è°ƒåº¦ç”¨ä¾‹æ€æƒ³ï¼Œä½†ä¸è¾“å‡ºä»»ä½•æºç å®ç°**çš„**Ray å¼‚æ„é›†ç¾¤ä¸Šå±‚è°ƒåº¦æ¡†æ¶æ¶æ„è®¾è®¡**ã€‚å†…å®¹èšç„¦**ç³»ç»Ÿåˆ†å±‚ã€æ¨¡å—èŒè´£ã€è°ƒåº¦è¯­ä¹‰ã€ä¾èµ–å…³ç³»**ï¼Œæ»¡è¶³ä½ æå‡ºçš„ä¸‰ä¸ªã€å¿…é¡»ã€‘ç³»ç»ŸåŠŸèƒ½éœ€æ±‚ï¼Œå¹¶éµå¾ªè‰¯å¥½çš„æ¶æ„è®¾è®¡åŸåˆ™ï¼ˆå•ä¸€èŒè´£ã€è§£è€¦ã€å¯æ‰©å±•ã€å¯è§‚æµ‹ï¼‰ã€‚

---

## æ€»ä½“è®¾è®¡ç›®æ ‡

è®¾è®¡ä¸€å¥—**ç‹¬ç«‹äº Ray å†…éƒ¨è°ƒåº¦å™¨ä¹‹ä¸Šçš„â€œä¸Šå±‚è°ƒåº¦ç®¡ç†æ¡†æ¶â€**ï¼Œç”¨äºåœ¨ **CentOSï¼ˆx86_64ï¼‰ä¸ MacOSï¼ˆARM64ï¼‰å¤šä¸ª Ray Cluster ä¹‹é—´**è¿›è¡Œç»Ÿä¸€èµ„æºæ„ŸçŸ¥ã€è´Ÿè½½å‡è¡¡ä¸ä»»åŠ¡ç¼–æ’ã€‚

è¯¥æ¡†æ¶çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. **å¤š Ray Cluster ç»Ÿä¸€è§†å›¾**
   å°†å¤šä¸ªå¼‚æ„ Ray é›†ç¾¤æŠ½è±¡ä¸ºä¸€ä¸ªâ€œé€»è¾‘èµ„æºæ± â€ï¼Œå¯¹ä¸Šå±‚åº”ç”¨é€æ˜ã€‚

2. **ç­–ç•¥å¯æ’æ‹”çš„è°ƒåº¦å†³ç­–**
   æ ¹æ®é›†ç¾¤å¥åº·åº¦ã€èµ„æºä½™é‡ã€æƒé‡ã€æ ‡ç­¾ï¼ˆOS / æ¶æ„ / GPUï¼‰ç­‰å› ç´ ï¼Œè¿›è¡Œæ™ºèƒ½è°ƒåº¦ã€‚

3. **ä»»åŠ¡çº§å¼ºä¸€è‡´æ‰§è¡Œè¯­ä¹‰**

   * åº”ç”¨å±‚æäº¤ Ray task / actor
   * è°ƒåº¦å™¨é€‰æ‹©é›†ç¾¤
   * ç­‰å¾…è¿œç¨‹æ‰§è¡Œç»“æœ
   * å¤±è´¥å³æŠ›å¼‚å¸¸ï¼ˆä¸åé”™ï¼‰

4. **å…·å¤‡æ’é˜Ÿä¸èƒŒå‹èƒ½åŠ›**
   å½“é›†ç¾¤è´Ÿè½½è¿‡é«˜æˆ–èµ„æºä¸è¶³æ—¶ï¼Œä»»åŠ¡è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè€Œéç›²ç›®å¤±è´¥ã€‚

---

## ã€ç³»ç»Ÿæ¶æ„å›¾ã€‘

```mermaid
flowchart TB
    subgraph AppLayer["åº”ç”¨å±‚"]
        A1["ä¸šåŠ¡åº”ç”¨ / SDK"]
    end

    subgraph SchedulerLayer["ä¸Šå±‚è°ƒåº¦æ§åˆ¶å¹³é¢"]
        B1["Job API æ¥å£å±‚"]
        B2["Task Queue & Backpressure"]
        B3["Scheduler Core"]
        B4["Policy Engine"]
        B5["Cluster Registry"]
        B6["Health Monitor"]
        B7["Connection Manager"]
    end

    subgraph DataPlane["Ray æ•°æ®å¹³é¢"]
        C1["Ray Cluster (CentOS x86_64)"]
        C2["Ray Cluster (MacOS ARM64)"]
    end

    A1 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B3 --> B5
    B4 --> B3
    B5 --> B6
    B3 --> B7
    B7 --> C1
    B7 --> C2
    C1 --> B6
    C2 --> B6
```

---

## ã€ç³»ç»Ÿé¡¹ç›®ç»“æ„æ ‘ã€‘

```plaintext
ray_multicluster_scheduler/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ client_api/
â”‚       â”œâ”€â”€ submit_task
â”‚       â””â”€â”€ submit_actor
â”‚
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ scheduler_core/
â”‚   â”‚   â”œâ”€â”€ dispatcher
â”‚   â”‚   â”œâ”€â”€ task_lifecycle
â”‚   â”‚   â””â”€â”€ result_collector
â”‚   â”‚
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”œâ”€â”€ task_queue
â”‚   â”‚   â””â”€â”€ backpressure_controller
â”‚   â”‚
â”‚   â”œâ”€â”€ policy/
â”‚   â”‚   â”œâ”€â”€ score_based_policy
â”‚   â”‚   â”œâ”€â”€ tag_affinity_policy
â”‚   â”‚   â””â”€â”€ weighted_preference_policy
â”‚   â”‚
â”‚   â”œâ”€â”€ cluster/
â”‚   â”‚   â”œâ”€â”€ cluster_registry
â”‚   â”‚   â”œâ”€â”€ cluster_metadata
â”‚   â”‚   â””â”€â”€ resource_snapshot
â”‚   â”‚
â”‚   â”œâ”€â”€ health/
â”‚   â”‚   â”œâ”€â”€ health_checker
â”‚   â”‚   â””â”€â”€ metrics_aggregator
â”‚   â”‚
â”‚   â””â”€â”€ connection/
â”‚       â”œâ”€â”€ ray_client_pool
â”‚       â””â”€â”€ connection_lifecycle
â”‚
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ exception/
â”‚   â””â”€â”€ logging/
â”‚
â””â”€â”€ control_plane/
    â”œâ”€â”€ config
    â””â”€â”€ admin_api
```

---

## ã€ç³»ç»Ÿæ¨¡å—è¯´æ˜ã€‘

### 1ï¸âƒ£ åº”ç”¨å±‚ï¼ˆAppLayerï¼‰

**èŒè´£**

* å‘è°ƒåº¦å™¨æäº¤ï¼š

  * Ray remote function
  * Ray actor class
* åŒæ­¥ç­‰å¾…æ‰§è¡Œç»“æœ
* ä¸æ„ŸçŸ¥åº•å±‚é›†ç¾¤å·®å¼‚

**ç‰¹ç‚¹**

* å¯¹ä¸šåŠ¡ä»£ç ä¾µå…¥æå°
* ä¸ç›´æ¥è°ƒç”¨ `ray.init()`

---

### 2ï¸âƒ£ Job API æ¥å£å±‚ï¼ˆJob APIï¼‰

**èŒè´£**

* æ¥æ”¶åº”ç”¨å±‚ä»»åŠ¡è¯·æ±‚
* ç»Ÿä¸€å°è£…ä»»åŠ¡æè¿°ï¼š

  * ä»£ç å¯¹è±¡
  * èµ„æºéœ€æ±‚ï¼ˆCPU / GPUï¼‰
  * æ¶æ„æ ‡ç­¾ï¼ˆarm64 / x86_64ï¼‰
* è½¬äº¤ç»™ä»»åŠ¡é˜Ÿåˆ—

---

### 3ï¸âƒ£ Task Queue & Backpressureï¼ˆä»»åŠ¡é˜Ÿåˆ—ä¸èƒŒå‹ï¼‰

**èŒè´£**

* ç»´æŠ¤å…¨å±€ä»»åŠ¡é˜Ÿåˆ—
* æ§åˆ¶å¹¶å‘æäº¤é€Ÿç‡
* å½“ï¼š

  * æ‰€æœ‰é›†ç¾¤èµ„æºç´§å¼ 
  * æˆ–ç­–ç•¥ä¸æ»¡è¶³
    â†’ ä»»åŠ¡æ’é˜Ÿç­‰å¾…

**è®¾è®¡åŸåˆ™**

* FIFO / ä¼˜å…ˆçº§é˜Ÿåˆ—å¯æ‰©å±•
* æ˜ç¡®â€œæ’é˜Ÿ â‰  å¤±è´¥â€

âœ… **æ»¡è¶³éœ€æ±‚ 3ï¼šç»´æŠ¤ä»»åŠ¡é˜Ÿåˆ—**

---

### 4ï¸âƒ£ Scheduler Coreï¼ˆè°ƒåº¦æ ¸å¿ƒï¼‰

**èŒè´£**

* ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡
* è¯·æ±‚è°ƒåº¦ç­–ç•¥å†³ç­–
* ç»‘å®šä»»åŠ¡ â†’ ç›®æ ‡é›†ç¾¤
* é©±åŠ¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼š

  * æäº¤
  * ç­‰å¾…
  * æˆåŠŸ / å¤±è´¥å›ä¼ 

**è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¤§è„‘**

---

### 5ï¸âƒ£ Policy Engineï¼ˆè°ƒåº¦ç­–ç•¥å¼•æ“ï¼‰

**èŒè´£**

* æ ¹æ® Cluster Snapshot è®¡ç®—è°ƒåº¦ç»“æœ
* æ”¯æŒå¤šç­–ç•¥ç»„åˆï¼š

  * èµ„æºå‰©ä½™è¯„åˆ†
  * æƒé‡åå¥½ï¼ˆCentOS å¸¸é©» / Mac å¼¹æ€§ï¼‰
  * æ ‡ç­¾äº²å’Œï¼ˆARM64 ä¸“å±ï¼‰

**ç‰¹ç‚¹**

* å¯æ’æ‹”
* ä¸å…³å¿ƒ Ray è¿æ¥ç»†èŠ‚

---

### 6ï¸âƒ£ Cluster Registryï¼ˆé›†ç¾¤æ³¨å†Œä¸­å¿ƒï¼‰

**èŒè´£**

* ç»´æŠ¤æ‰€æœ‰ Ray Cluster çš„ï¼š

  * åœ°å€
  * æ¶æ„
  * æƒé‡
  * æ ‡ç­¾
* æä¾›ç»Ÿä¸€æŸ¥è¯¢æ¥å£

---

### 7ï¸âƒ£ Health Monitorï¼ˆé›†ç¾¤å¥åº·ç›‘æ§ï¼‰

**èŒè´£**

* å®šæœŸé‡‡é›†ï¼š

  * available_resources
  * cluster_resources
  * node æ•°
* å½¢æˆèµ„æºå¿«ç…§ï¼ˆSnapshotï¼‰
* ä¸å‚ä¸è°ƒåº¦å†³ç­–ï¼Œä»…æä¾›äº‹å®æ•°æ®

---

### 8ï¸âƒ£ Connection Managerï¼ˆRay è¿æ¥ç®¡ç†ï¼‰

**èŒè´£**

* ç»´æŠ¤ Ray Client / Ray Job è¿æ¥æ± 
* ä¿è¯ï¼š

  * ä¸€ä¸ªä»»åŠ¡åªè¿æ¥ä¸€ä¸ªé›†ç¾¤
  * è¿æ¥ç”Ÿå‘½å‘¨æœŸå¯æ§
* æ‰§è¡ŒçœŸæ­£çš„ `ray.remote` æäº¤

âœ… **æ»¡è¶³éœ€æ±‚ 1ï¼šå°† task / actor åˆ†é…åˆ°ç‰¹å®šé›†ç¾¤**

---

### 9ï¸âƒ£ Result Collectorï¼ˆç»“æœå›æ”¶ï¼‰

**èŒè´£**

* åŒæ­¥ç­‰å¾… Ray future
* æˆåŠŸ â†’ è¿”å›ç»“æœ
* å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼ˆä¸ä¸­æ–­ç³»ç»Ÿï¼‰

âœ… **æ»¡è¶³éœ€æ±‚ 2ï¼šç­‰å¾…ç»“æœ & å¤±è´¥æŠ›å¼‚å¸¸**

---

## ã€æ¨¡å—ä¾èµ–é“¾ã€‘

```text
Application
  â†“
Job API
  â†“
Task Queue
  â†“
Scheduler Core
  â†“
Policy Engine
  â†“
Cluster Registry
  â†“
Health Monitor
  â†“
Connection Manager
  â†“
Ray Cluster
  â†“
Result Collector
  â†“
Application
```

---

## è°ƒåº¦è®¾è®¡æ€»ç»“ï¼ˆæ¶æ„çº§ï¼‰

| ç»´åº¦   | è®¾è®¡é€‰æ‹©         |
| ---- | ------------ |
| è°ƒåº¦å±‚çº§ | Ray ä¹‹ä¸Šï¼ˆæ§åˆ¶å¹³é¢ï¼‰ |
| å¼‚æ„æ”¯æŒ | OS / æ¶æ„ / æ ‡ç­¾ |
| è°ƒåº¦ç­–ç•¥ | å¯æ’æ‹”ã€å¤šå› å­è¯„åˆ†    |
| æ‰§è¡Œè¯­ä¹‰ | åŒæ­¥ã€å¼ºä¸€è‡´       |
| èƒŒå‹èƒ½åŠ› | é˜Ÿåˆ—åŒ–          |
| å¯æ‰©å±•æ€§ | æ”¯æŒ N ä¸ªé›†ç¾¤     |

---

### ğŸ”‘ ä¸€å¥è¯æ€»ç»“

> **è¿™æ˜¯ä¸€ä¸ªâ€œRay Cluster ä¹‹ä¸Šçš„ Kubernetes é£æ ¼è°ƒåº¦æ§åˆ¶å¹³é¢â€ï¼ŒRay åªè´Ÿè´£å•é›†ç¾¤æ‰§è¡Œï¼Œè€Œä½ è¿™ä¸ªç³»ç»Ÿè´Ÿè´£â€œé€‰å“ªä¸ª Ray é›†ç¾¤â€ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ è¿›ä¸€æ­¥ï¼š

* æŠŠè¯¥æ¶æ„**æ˜ å°„åˆ° KubeRay + RayJob**
* æˆ–è®¾è®¡ **Scheduler ä¸ Ray Serve / Actor Pool çš„ç»“åˆæ–¹æ¡ˆ**
* æˆ–ç»™å‡º **ç”Ÿäº§çº§å¤±è´¥é‡è¯• / ç†”æ–­è®¾è®¡**

ä½ å¯ä»¥ç›´æ¥æŒ‡å®šä¸‹ä¸€æ­¥æ–¹å‘ã€‚


# ã€é¡¹ç›®å®Œæ•´å®æ–½è®¡åˆ’ã€‘
# é¡¹ç›®æ€»ä½“ç›®æ ‡
æ„å»ºä¸€ä¸ªç‹¬ç«‹äºRayå†…éƒ¨è°ƒåº¦å™¨ä¹‹ä¸Šçš„â€œä¸Šå±‚è°ƒåº¦ç®¡ç†æ¡†æ¶â€ï¼Œå®ç°å¯¹å¤šä¸ªå¼‚æ„Rayé›†ç¾¤ï¼ˆCentOS x86_64ä¸MacOS ARM64ï¼‰çš„ç»Ÿä¸€èµ„æºè§†å›¾ã€ç­–ç•¥åŒ–è°ƒåº¦ã€å¼ºä¸€è‡´ä»»åŠ¡æ‰§è¡Œä¸èƒŒå‹ç®¡ç†ï¼Œä¸ºä¸Šå±‚åº”ç”¨æä¾›é€æ˜ã€å¯é çš„åˆ†å¸ƒå¼è®¡ç®—æœåŠ¡ã€‚

# é¡¹ç›®å¼€å‘æ¨¡å¼
æœ¬é¡¹ç›®é‡‡ç”¨â€œè‡ªåº•å‘ä¸Šã€åˆ†å±‚æ„å»ºã€æ¨¡å—è§£è€¦ã€å¹¶è¡Œå¼€å‘â€çš„æ¨¡å¼ã€‚æ ¸å¿ƒåŸåˆ™å¦‚ä¸‹ï¼š
1.  **åº•å±‚æ¨¡å—ä¼˜å…ˆ**ï¼šä¼˜å…ˆå®æ–½ä¸ä¾èµ–å…¶ä»–ç³»ç»Ÿæ¨¡å—çš„åŸºç¡€è®¾æ–½å’Œæ•°æ®å¤„ç†æ¨¡å—ï¼ˆå¦‚æ•°æ®æ¨¡å‹ã€å¼‚å¸¸å¤„ç†ã€é…ç½®ç®¡ç†ï¼‰ã€‚
2.  **ä¾èµ–é©±åŠ¨ç¼–æ’**ï¼šä¸¥æ ¼éµå¾ªæ¶æ„è®¾è®¡çš„ä¾èµ–é“¾ï¼ˆå¦‚ `Health Monitor` -> `Cluster Registry` -> `Policy Engine` -> `Scheduler Core`ï¼‰ã€‚ä¸Šæ¸¸æ¨¡å—çš„å¼€å‘åŸºäºä¸‹æ¸¸æ¨¡å—æä¾›çš„ç¨³å®šæ¥å£ã€‚
3.  **é˜¶æ®µåŒ–ä¸é€’å½’åˆ†è§£**ï¼šå°†æ•´ä½“å¼€å‘åˆ†è§£ä¸ºå¤šä¸ªé€»è¾‘é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µèšç„¦ä¸€ç»„åŠŸèƒ½é›†ï¼Œé˜¶æ®µå†…çš„ä»»åŠ¡è¿›ä¸€æ­¥é€’å½’åˆ†è§£ä¸ºå¯ç›´æ¥ç¼–ç çš„æœ€å°å®æ–½å•å…ƒï¼ˆé€šå¸¸å¯¹åº”1-2ä¸ªæ¨¡å—æ–‡ä»¶ï¼‰ã€‚
4.  **æ¨¡å—åŒ–å¹¶è¡Œ**ï¼šåœ¨æ˜ç¡®æ¥å£å¥‘çº¦çš„å‰æä¸‹ï¼Œå…è®¸ç‹¬ç«‹æ¨¡å—å¹¶è¡Œå¼€å‘ï¼ˆå¦‚ `Health` ç›‘æ§ä¸ `Connection` ç®¡ç†ï¼‰ï¼Œæå‡æ•´ä½“å¼€å‘æ•ˆç‡ã€‚

# é¡¹ç›®å®æ–½é˜¶æ®µä»»åŠ¡

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ•°æ®æ¨¡å‹ä¸ç³»ç»ŸåŸºçŸ³
**ç›®æ ‡**ï¼šå®šä¹‰ç³»ç»Ÿæ ¸å¿ƒæ•°æ®ç»“æ„ã€å¼‚å¸¸ä½“ç³»ã€æ—¥å¿—é…ç½®ï¼Œä¸ºæ‰€æœ‰ä¸Šå±‚æ¨¡å—æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£å’Œè¿è¡ŒåŸºç¡€ã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 1.1: å®šä¹‰æ ¸å¿ƒæ•°æ®æ¨¡å‹ (`common/model`)
- 1.1.1 å®æ–½å†…å®¹ï¼šå®šä¹‰ `TaskDescription`, `ClusterMetadata`, `ResourceSnapshot`, `SchedulingDecision` ç­‰æ ¸å¿ƒæ•°æ®ç±»ï¼Œæ˜ç¡®å…¶å­—æ®µã€ç±»å‹åŠåºåˆ—åŒ–æ–¹æ³•ã€‚
- 1.1.2 ä¾èµ–é¡¹ï¼šæ— ã€‚
- 1.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/common/model/__init__.py`

##### 1.2: æ„å»ºå¼‚å¸¸å¤„ç†æ¡†æ¶ (`common/exception`)
- 1.2.1 å®æ–½å†…å®¹ï¼šå®šä¹‰é¡¹ç›®çº§åŸºç¡€å¼‚å¸¸ï¼ˆå¦‚ `SchedulerError`ï¼‰åŠå…³é”®é¢†åŸŸå¼‚å¸¸ï¼ˆå¦‚ `NoHealthyClusterError`, `TaskSubmissionError`, `PolicyEvaluationError`ï¼‰ã€‚
- 1.2.2 ä¾èµ–é¡¹ï¼šæ— ã€‚
- 1.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/common/exception/__init__.py`

##### 1.3: é…ç½®æ—¥å¿—ä¸å·¥å…· (`common/logging`, `control_plane/config`)
- 1.3.1 å®æ–½å†…å®¹ï¼šé…ç½®é¡¹ç›®çº§ç»“æ„åŒ–æ—¥å¿—ï¼›å®ç°åŸºç¡€é…ç½®ç®¡ç†ï¼Œæ”¯æŒä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è¯»å–é›†ç¾¤åˆ—è¡¨ã€å¥åº·æ£€æŸ¥é—´éš”ç­‰ã€‚
- 1.3.2 ä¾èµ–é¡¹ï¼šæ— ã€‚
- 1.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/common/logging/__init__.py`
    - `ray_multicluster_scheduler/control_plane/config/__init__.py`

#### å­ä»»åŠ¡å®æ–½è·¯å¾„
```mermaid
flowchart LR
    A[1.1 å®šä¹‰æ•°æ®æ¨¡å‹] --> B[1.2 æ„å»ºå¼‚å¸¸æ¡†æ¶];
    B --> C[1.3 é…ç½®æ—¥å¿—ä¸å·¥å…·];
```

### ç¬¬äºŒé˜¶æ®µï¼šé›†ç¾¤æ„ŸçŸ¥ä¸çŠ¶æ€ç»´æŠ¤
**ç›®æ ‡**ï¼šå®ç°é›†ç¾¤çŠ¶æ€ï¼ˆèµ„æºã€å¥åº·åº¦ï¼‰çš„å®æ—¶æ„ŸçŸ¥ä¸ç»Ÿä¸€æ³¨å†Œç®¡ç†ï¼Œä¸ºè°ƒåº¦å†³ç­–æä¾›å‡†ç¡®çš„æ•°æ®æºã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 2.1: å®ç°å¥åº·ç›‘æ§å™¨ (`health/health_checker`)
- 2.1.1 å®æ–½å†…å®¹ï¼šå®ç° `HealthChecker` ç±»ï¼Œé€šè¿‡ Ray Client å®šæœŸè½®è¯¢å„é›†ç¾¤çš„ `available_resources`ã€`cluster_resources` åŠèŠ‚ç‚¹çŠ¶æ€ï¼Œç»„è£… `ResourceSnapshot`ã€‚
- 2.1.2 ä¾èµ–é¡¹ï¼š`common/model` (ResourceSnapshot), `common/logging`, `control_plane/config`ã€‚
- 2.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/health/health_checker.py`

##### 2.2: å®ç°é›†ç¾¤æ³¨å†Œä¸­å¿ƒ (`cluster/cluster_registry`, `cluster/cluster_metadata`)
- 2.2.1 å®æ–½å†…å®¹ï¼šå®ç° `ClusterRegistry` ç±»ï¼Œç»´æŠ¤é™æ€çš„ `ClusterMetadata` åˆ—è¡¨ï¼ˆåœ°å€ã€æ ‡ç­¾ã€æƒé‡ï¼‰ï¼Œå¹¶æä¾›æ³¨å†Œã€æŸ¥è¯¢ã€è·å–æœ€æ–° `ResourceSnapshot` çš„æ¥å£ã€‚
- 2.2.2 ä¾èµ–é¡¹ï¼š`common/model` (ClusterMetadata, ResourceSnapshot), `health_checker` (ä½œä¸ºæ•°æ®æä¾›è€…)ã€‚
- 2.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/scheduler/cluster/cluster_registry.py`
    - `ray_multicluster_scheduler/scheduler/cluster/cluster_metadata.py`

##### 2.3: å®ç°è¿æ¥ç®¡ç†å±‚ (`connection/ray_client_pool`, `connection/connection_lifecycle`)
- 2.3.1 å®æ–½å†…å®¹ï¼šå®ç° `RayClientPool` ç±»ï¼Œç®¡ç†åˆ°å„é›†ç¾¤çš„ Ray Client è¿æ¥æ± ï¼Œè´Ÿè´£è¿æ¥çš„åˆ›å»ºã€ç¼“å­˜ã€å¤ç”¨å’Œä¼˜é›…å…³é—­ï¼Œç¡®ä¿ä»»åŠ¡æäº¤æ—¶èƒ½å¿«é€Ÿè·å–æœ‰æ•ˆè¿æ¥ã€‚
- 2.3.2 ä¾èµ–é¡¹ï¼š`cluster_registry` (è·å–é›†ç¾¤åœ°å€), `common/logging`ã€‚
- 2.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/scheduler/connection/ray_client_pool.py`
    - `ray_multicluster_scheduler/scheduler/connection/connection_lifecycle.py`

#### å­ä»»åŠ¡å®æ–½è·¯å¾„
```mermaid
flowchart LR
    subgraph Phase1 [å‰ç½®ä¾èµ–]
        P1[æ•°æ®æ¨¡å‹ç­‰]
    end

    P1 --> A;
    A[2.1 å¥åº·ç›‘æ§å™¨] --> B[2.2 é›†ç¾¤æ³¨å†Œä¸­å¿ƒ];
    B --> C[2.3 è¿æ¥ç®¡ç†å±‚];
```

### ç¬¬ä¸‰é˜¶æ®µï¼šè°ƒåº¦ç­–ç•¥ä¸å†³ç­–å¼•æ“
**ç›®æ ‡**ï¼šå®ç°å¯æ’æ‹”çš„è°ƒåº¦ç­–ç•¥ï¼Œå¹¶æ„å»ºç­–ç•¥å¼•æ“ï¼Œèƒ½å¤ŸåŸºäºé›†ç¾¤çŠ¶æ€è®¡ç®—æœ€ä¼˜è°ƒåº¦ç›®æ ‡ã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 3.1: å®ç°åŸºç¡€è¯„åˆ†ç­–ç•¥ (`policy/score_based_policy`)
- 3.1.1 å®æ–½å†…å®¹ï¼šå®ç° `ScoreBasedPolicy` ç±»ï¼Œæ ¹æ®é›†ç¾¤çš„å¯ç”¨ CPU/GPU èµ„æºä½™é‡è¿›è¡Œå½’ä¸€åŒ–è¯„åˆ†ï¼Œé€‰æ‹©åˆ†æ•°æœ€é«˜çš„é›†ç¾¤ã€‚
- 3.1.2 ä¾èµ–é¡¹ï¼š`cluster_registry` (è·å–é›†ç¾¤å¿«ç…§), `common/model` (TaskDescription, SchedulingDecision)ã€‚
- 3.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/policy/score_based_policy.py`

##### 3.2: å®ç°æ ‡ç­¾äº²å’Œç­–ç•¥ (`policy/tag_affinity_policy`)
- 3.2.1 å®æ–½å†…å®¹ï¼šå®ç° `TagAffinityPolicy` ç±»ï¼Œä¼˜å…ˆå°†ä»»åŠ¡è°ƒåº¦åˆ°ä¸å…¶ `arch` æ ‡ç­¾åŒ¹é…çš„é›†ç¾¤ï¼ˆå¦‚ `arm64` ä»»åŠ¡å‘å¾€ MacOS é›†ç¾¤ï¼‰ã€‚
- 3.2.2 ä¾èµ–é¡¹ï¼šåŒ 3.1.2ã€‚
- 3.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/policy/tag_affinity_policy.py`

##### 3.3: æ„å»ºç­–ç•¥å¼•æ“ (`policy/`)
- 3.3.1 å®æ–½å†…å®¹ï¼šå®ç° `PolicyEngine` ç±»ï¼Œæ”¯æŒç­–ç•¥çš„æ³¨å†Œã€ç»„åˆï¼ˆå¦‚é“¾å¼ã€åŠ æƒï¼‰ä¸æ‰§è¡Œã€‚æä¾›ç»Ÿä¸€çš„ `schedule(task_desc, cluster_snapshots)` æ¥å£ã€‚
- 3.3.2 ä¾èµ–é¡¹ï¼š`policy/score_based_policy`, `policy/tag_affinity_policy`ã€‚
- 3.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/policy/__init__.py` (æˆ– `policy_engine.py`)

#### å­ä»»åŠ¡å®æ–½è·¯å¾„
```mermaid
flowchart LR
    subgraph Phase2 [å‰ç½®ä¾èµ–]
        P2[é›†ç¾¤æ³¨å†Œä¸­å¿ƒ]
    end

    P2 --> A;
    P2 --> B;
    A[3.1 è¯„åˆ†ç­–ç•¥] --> C[3.3 ç­–ç•¥å¼•æ“];
    B[3.2 æ ‡ç­¾ç­–ç•¥] --> C;
```

### ç¬¬å››é˜¶æ®µï¼šè°ƒåº¦æ ¸å¿ƒä¸ä»»åŠ¡æ‰§è¡Œæµ
**ç›®æ ‡**ï¼šå®ç°è°ƒåº¦ç³»ç»Ÿçš„å¤§è„‘ï¼Œä¸²è”ä»»åŠ¡é˜Ÿåˆ—ã€ç­–ç•¥å†³ç­–ã€è¿æ¥æ‰§è¡Œä¸ç»“æœå›æ”¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 4.1: å®ç°ä»»åŠ¡é˜Ÿåˆ—ä¸èƒŒå‹æ§åˆ¶å™¨ (`queue/task_queue`, `queue/backpressure_controller`)
- 4.1.1 å®æ–½å†…å®¹ï¼šå®ç° `TaskQueue` (æ”¯æŒ FIFO/ä¼˜å…ˆçº§) å’Œ `BackpressureController`ï¼Œå½“æ‰€æœ‰é›†ç¾¤è´Ÿè½½è¿‡é«˜æ—¶ï¼Œæš‚åœä»é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ã€‚
- 4.1.2 ä¾èµ–é¡¹ï¼š`common/model` (TaskDescription)ã€‚
- 4.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/scheduler/queue/task_queue.py`
    - `ray_multicluster_scheduler/scheduler/queue/backpressure_controller.py`

##### 4.2: å®ç°è°ƒåº¦æ ¸å¿ƒä¸ç»“æœæ”¶é›†å™¨ (`scheduler_core/dispatcher`, `scheduler_core/result_collector`)
- 4.2.1 å®æ–½å†…å®¹ï¼šå®ç° `Dispatcher`ï¼Œä»é˜Ÿåˆ—å–ä»»åŠ¡ï¼Œè°ƒç”¨ç­–ç•¥å¼•æ“å†³ç­–ï¼Œé€šè¿‡è¿æ¥æ± æäº¤ä»»åŠ¡ï¼Œå¹¶è¿”å› `future`ã€‚å®ç° `ResultCollector` åŒæ­¥ç­‰å¾… `future` å®Œæˆï¼Œå¤„ç†æˆåŠŸç»“æœæˆ–å°è£…å¼‚å¸¸ã€‚
- 4.2.2 ä¾èµ–é¡¹ï¼š`policy_engine`, `ray_client_pool`, `task_queue`, `common/model`ã€‚
- 4.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/scheduler/scheduler_core/dispatcher.py`
    - `ray_multicluster_scheduler/scheduler/scheduler_core/result_collector.py`

##### 4.3: ç»„è£…è°ƒåº¦æ ¸å¿ƒæœåŠ¡ (`scheduler_core/task_lifecycle`)
- 4.3.1 å®æ–½å†…å®¹ï¼šå®ç° `SchedulerCore` ç±»ï¼Œæ•´åˆ `Dispatcher`ã€`ResultCollector` å’ŒèƒŒå‹æ§åˆ¶ï¼Œæä¾› `submit_task` å’Œ `submit_actor` ä¸»å¾ªç¯æˆ–å¼‚æ­¥æ¥å£ï¼Œç®¡ç†ä»»åŠ¡å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚
- 4.3.2 ä¾èµ–é¡¹ï¼š`dispatcher`, `result_collector`, `backpressure_controller`ã€‚
- 4.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/scheduler_core/task_lifecycle.py`

#### å­ä»»åŠ¡å®æ–½è·¯å¾„
```mermaid
flowchart LR
    subgraph PreReq [å‰ç½®ä¾èµ–]
        P1[æ•°æ®æ¨¡å‹]
        P2[ç­–ç•¥å¼•æ“]
        P3[è¿æ¥æ± ]
    end

    P1 --> A;
    A[4.1 ä»»åŠ¡é˜Ÿåˆ—] --> B[4.2 è°ƒåº¦ä¸ç»“æœæ”¶é›†];
    P2 --> B;
    P3 --> B;
    B --> C[4.3 ç»„è£…è°ƒåº¦æ ¸å¿ƒ];
```

### ç¬¬äº”é˜¶æ®µï¼šåº”ç”¨æ¥å£ä¸ç³»ç»Ÿé›†æˆ
**ç›®æ ‡**ï¼šæš´éœ²å¯¹ç”¨æˆ·å‹å¥½çš„ APIï¼Œå¹¶é›†æˆæ‰€æœ‰æ¨¡å—ï¼Œå½¢æˆå¯è¿è¡Œçš„ç³»ç»Ÿã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 5.1: å®ç° Job API æ¥å£å±‚ (`app/client_api/submit_task`, `app/client_api/submit_actor`)
- 5.1.1 å®æ–½å†…å®¹ï¼šå®ç°ç”¨æˆ·ä¾§ SDKï¼Œæä¾› `submit_task(fn, args, kwargs, resource_requirements, tags)` å’Œ `submit_actor(cls, ...)` å‡½æ•°ã€‚å†…éƒ¨è°ƒç”¨ `SchedulerCore`ã€‚
- 5.1.2 ä¾èµ–é¡¹ï¼š`scheduler_core`ã€‚
- 5.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/app/client_api/submit_task.py`
    - `ray_multicluster_scheduler/app/client_api/submit_actor.py`

##### 5.2: å®ç°æ§åˆ¶å¹³é¢ä¸ç®¡ç†API (`control_plane/admin_api`)
- 5.2.1 å®æ–½å†…å®¹ï¼šå®ç°ç®€å•çš„ç®¡ç†æ¥å£ï¼ˆå¦‚ REST æˆ– CLIï¼‰ï¼Œç”¨äºæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ã€é˜Ÿåˆ—é•¿åº¦ã€æ‰‹åŠ¨è§¦å‘å¥åº·æ£€æŸ¥ç­‰ã€‚
- 5.2.2 ä¾èµ–é¡¹ï¼š`cluster_registry`, `task_queue`, `health_checker`ã€‚
- 5.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/control_plane/admin_api/__init__.py`

##### 5.3: ç³»ç»Ÿé›†æˆä¸ç«¯åˆ°ç«¯æµ‹è¯•
- 5.3.1 å®æ–½å†…å®¹ï¼šç¼–å†™ä¸»ç¨‹åºå…¥å£ï¼Œåˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶ï¼ˆé…ç½®ã€æ³¨å†Œä¸­å¿ƒã€å¥åº·æ£€æŸ¥ã€è°ƒåº¦æ ¸å¿ƒï¼‰ã€‚ç¼–å†™ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ï¼ŒéªŒè¯ä» API æäº¤ä»»åŠ¡åˆ°è·å–ç»“æœçš„å®Œæ•´æµç¨‹ã€‚
- 5.3.2 ä¾èµ–é¡¹ï¼šæ‰€æœ‰å‰è¿°æ¨¡å—ã€‚
- 5.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š
    - `ray_multicluster_scheduler/__main__.py` (æˆ– `main.py`)
    - `tests/integration/test_e2e_workflow.py`

#### å­ä»»åŠ¡å®æ–½è·¯å¾„
```mermaid
flowchart LR
    subgraph PreReq [å‰ç½®ä¾èµ–]
        P4[è°ƒåº¦æ ¸å¿ƒ]
        P5[é›†ç¾¤æ³¨å†Œä¸­å¿ƒç­‰]
    end

    P4 --> A[5.1 å®ç°Job API];
    P5 --> B[5.2 ç®¡ç†API];
    A --> C[5.3 ç³»ç»Ÿé›†æˆ];
    B --> C;
```

### ç¬¬å…­é˜¶æ®µï¼šè¿›é˜¶åŠŸèƒ½ä¸ç”Ÿäº§å°±ç»ª
**ç›®æ ‡**ï¼šå¢å¼ºç³»ç»Ÿçš„å¥å£®æ€§ã€å¯è§‚æµ‹æ€§å’Œé«˜çº§è°ƒåº¦èƒ½åŠ›ã€‚
#### é˜¶æ®µå­ä»»åŠ¡åˆ—è¡¨
##### 6.1: å®ç°æŒ‡æ ‡èšåˆä¸å¯è§‚æµ‹æ€§ (`health/metrics_aggregator`)
- 6.1.1 å®æ–½å†…å®¹ï¼šæ‰©å±• `HealthMonitor` æˆ–æ–°å¢ `MetricsAggregator`ï¼Œæ”¶é›†å¹¶æš´éœ² Prometheus æ ¼å¼çš„æŒ‡æ ‡ï¼ˆå¦‚å„é›†ç¾¤èµ„æºä½¿ç”¨ç‡ã€ä»»åŠ¡æ’é˜Ÿæ—¶é—´ã€è°ƒåº¦æˆåŠŸç‡ï¼‰ã€‚
- 6.1.2 ä¾èµ–é¡¹ï¼š`health_checker`, `task_queue`ã€‚
- 6.1.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/health/metrics_aggregator.py`

##### 6.2: å®ç°æƒé‡åå¥½ç­–ç•¥ (`policy/weighted_preference_policy`)
- 6.2.1 å®æ–½å†…å®¹ï¼šå®ç° `WeightedPreferencePolicy`ï¼Œå…è®¸ä¸ºé›†ç¾¤é…ç½®é™æ€æƒé‡ï¼Œç»“åˆèµ„æºè¯„åˆ†è¿›è¡ŒåŠ æƒå†³ç­–ï¼Œå®ç°å¦‚â€œCentOS å¸¸é©»ï¼ŒMac å¼¹æ€§â€çš„è°ƒåº¦å€¾å‘ã€‚
- 6.2.2 ä¾èµ–é¡¹ï¼š`cluster_registry`, `common/model`ã€‚
- 6.2.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼š`ray_multicluster_scheduler/scheduler/policy/weighted_preference_policy.py`

##### 6.3: å®Œå–„å¤±è´¥é‡è¯•ä¸ç†”æ–­æœºåˆ¶
- 6.3.1 å®æ–½å†…å®¹ï¼šåœ¨ `SchedulerCore` æˆ– `Dispatcher` ä¸­å¼•å…¥ä»»åŠ¡çº§åˆ«é‡è¯•é€»è¾‘ï¼ˆå¯é…ç½®æ¬¡æ•°ã€é€€é¿ç­–ç•¥ï¼‰ã€‚åœ¨ `HealthChecker` æˆ– `ConnectionManager` ä¸­ä¸ºé¢‘ç¹å¤±è´¥çš„é›†ç¾¤å¼•å…¥ç†”æ–­å™¨ã€‚
- 6.3.2 ä¾èµ–é¡¹ï¼š`scheduler_core`, `health_checker`, `connection`ã€‚
- 6.3.3 äº¤ä»˜æ¨¡å—æ–‡ä»¶ï¼šä¿®æ”¹ `scheduler/scheduler_core/task_lifecycle.py` å’Œ `scheduler/health/health_checker.py`ï¼Œæˆ–æ–°å¢ `common/circuit_breaker.py`ã€‚

# ã€çº¦æŸæ¡ä»¶ã€‘
- 1. ä¸¥æ ¼éµå®ˆé¡¹ç›®å¼€å‘è®¡åˆ’
- 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—å¿…é¡»è¿›è¡Œ**å•å…ƒæµ‹è¯•**ï¼Œç»„åˆæ¨¡å—å¿…é¡»è¿›è¡Œ**é›†æˆæµ‹è¯•**
- 3. æ¶ˆé™¤ä¸€åˆ‡ bug

# ã€Ray ç³»ç»Ÿé›†ç¾¤ä¿¡æ¯ã€‘
ClusterConfig= {
    "centos": ClusterConfig(
        name="centos",
        head_address="192.168.5.7:32546",
        dashboard="http://192.168.5.7:31591",
        prefer=False,
        weight=1.0,
        tags=["linux", "x86_64"]
    ),
    "mac": ClusterConfig(
        name="mac",
        head_address="192.168.5.2:32546",
        dashboard="http://192.168.5.2:8265",
        prefer=True,
        weight=1.2,  # åå¥½é›†ç¾¤æƒé‡æ›´é«˜
        tags=["macos", "arm64"]
    )
}

# ã€ä»»åŠ¡éœ€æ±‚ã€‘
- 1. æ ¹æ®é¡¹ç›®è®¡åˆ’ä¸ä»»åŠ¡å®æ–½è·¯å¾„çš„å®‰æ’ï¼ŒæŒ‰ç…§ä¾èµ–å€’ç½®åŸåˆ™ï¼Œä¾æ¬¡å®Œæˆç³»ç»ŸæŒ‡å®šæ¨¡å—çš„å¼€å‘
- 2. å®ç°ä¸€ä¸ªç®€å•çš„ ray job æäº¤åˆ°é›†ç¾¤è¿›è¡Œè°ƒåº¦çš„æµ‹è¯•ç”¨ä¾‹
- 3. å°†å®Œæ•´é¡¹ç›®é…ç½®æˆ PyPi python å®‰è£…åŒ…ï¼ŒåŒ…åä¸ºâ€œray_multicluster_schedulerâ€, å¹¶å®‰è£…åœ¨æœ¬åœ° conda ts è™šæ‹Ÿç¯å¢ƒ
